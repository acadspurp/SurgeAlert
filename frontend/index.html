<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SurgeAlert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link href="styles.css" rel="stylesheet" />
    <style>
      /* small helper for button glow on hover (keeps consistent with your theme) */
      .btn-animated {
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }
      .btn-animated:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(12,50,74,0.12);
      }
      /* responsive spacing for right column buttons card */
      @media (min-width: 640px) {
        .actions-buttons-row { display: flex; gap: 1rem; }
        .actions-buttons-row button { flex: 1; }
      }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="flex flex-col min-h-screen">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <span class="font-bold text-xl text-blue-600 cursor-pointer" onclick="showView('home')">SurgeAlert</span>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="#" onclick="showView('home')" class="text-gray-700 hover:bg-blue-500 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Home</a>
                            <a href="#" onclick="showView('maps')" class="text-gray-700 hover:bg-blue-500 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Maps</a>
                            <a href="#" class="text-gray-700 hover:bg-blue-500 hover:text-white px-3 py-2 rounded-md text-sm font-medium">About</a>
                        </div>
                    </div>
                    <div class="hidden md:block">
                         <button onclick="showView('login')" id="login-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Login</button>
                         <button onclick="handleLogout()" id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700" style="display:none;">Logout</button>
                         <span id="user-name" class="text-gray-700 px-3 py-2 text-sm font-medium" style="display:none;"></span>
                    </div>
                    <div class="-mr-2 flex md:hidden">
                        <button type="button" class="bg-gray-200 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white" aria-controls="mobile-menu" aria-expanded="false" id="mobile-menu-button">
                            <span class="sr-only">Open main menu</span>
                            <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </nav>
            <div class="md:hidden" id="mobile-menu" style="display: none;">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="#" onclick="showView('home')" class="text-gray-700 block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-500 hover:text-white">Home</a>
                    <a href="#" onclick="showView('maps')" class="text-gray-700 block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-500 hover:text-white">Maps</a>
                    <a href="#" class="text-gray-700 block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-500 hover:text-white">About</a>
                    <button onclick="showView('login')" id="mobile-login-btn" class="bg-blue-600 text-white w-full text-left mt-2 px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Login</button>
                    <button onclick="handleLogout()" id="mobile-logout-btn" class="bg-red-600 text-white w-full text-left mt-2 px-3 py-2 rounded-md text-base font-medium hover:bg-red-700" style="display:none;">Logout</button>
                </div>
            </div>
        </header>

        <main id="main-content" class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="home-view">
                 <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">SurgeAlert</h1>
                    <p class="text-lg text-gray-600">Intelligent flood monitoring and alert system for Barangay Marulas, Valenzuela City.</p>
                 </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-2 space-y-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Live Camera Feed - Tullahan River (Marulas)</h2>
                            <div class="aspect-w-16 aspect-h-9 bg-black rounded-lg overflow-hidden">
                               <iframe width="100%" height="450" src="https://www.youtube.com/embed/g2iP_s57e84?autoplay=1&mute=1&loop=1&playlist=g2iP_s57e84&controls=0" title="Tullahan River Live Stream" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>
                             <div class="mt-4 text-sm text-gray-500">
                                <p>This is a live feed from SurgeAlert Cam. It provides a real-time visual of the river's condition.</p>
                            </div>
                        </div>

                        <div id="left-alert-card" class="bg-white p-6 rounded-lg shadow-md">
                            <div class="text-center">
                                <p class="text-sm text-gray-600 mb-1">Current water level:</p>
                                <p id="water-level" class="text-5xl font-bold">14.50 m</p>
                                <p id="alert-level" class="text-lg mt-2 font-semibold">LEVEL 1 GREEN ‚Äî BE AWARE & PREPARE</p>
                            </div>

                            <div class="mt-4">
                                <h3 class="font-semibold mb-2">Legend:</h3>
                                <ul class="space-y-1 text-sm">
                                    <li class="flex items-center"><span class="h-4 w-4 rounded-full bg-green-500 mr-2"></span> Green: Normal (<15m)</li>
                                    <li class="flex items-center"><span class="h-4 w-4 rounded-full bg-yellow-400 mr-2"></span> Yellow: Caution (15m - 16m)</li>
                                    <li class="flex items-center"><span class="h-4 w-4 rounded-full bg-orange-500 mr-2"></span> Orange: Prepare (16m - 18m)</li>
                                    <li class="flex items-center"><span class="h-4 w-4 rounded-full bg-red-600 mr-2"></span> Red: Evacuate (>18m)</li>
                                </ul>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Weather Forecast</h2>
                            <div id="weather-forecast" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 text-center">
                                <div class="flex items-center justify-center h-32">
                                    <p class="text-gray-500">Loading weather data...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <div id="actions-card" class="bg-white p-6 rounded-lg shadow-md border-l-8 border-green-500">
                             <h2 class="text-2xl font-semibold mb-4 text-gray-700">Actions</h2>

                             <div id="alert-description" class="text-sm text-gray-700">
                                 </div>
                        </div>

                        <div id="tide-forecast-card" class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Tide Forecast</h2>
                            <p class="text-sm text-gray-600 mb-4">
                                Tidal predictions for Manila Bay, which affects the Tullahan River's drainage.
                            </p>
                            <div id="tide-data-container">
                                <p class="text-sm text-gray-500 mb-2">Data for: <strong>November 6, 2025</strong> (Today)</p>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                                        <span class="font-semibold text-blue-500 flex items-center">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                            Low Tide
                                        </span>
                                        <strong>4:53 AM</strong>
                                    </li>
                                    <li class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                                        <span class="font-semibold text-blue-700 flex items-center">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                            High Tide
                                        </span>
                                        <strong>11:33 AM</strong>
                                    </li>
                                    <li class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                                        <span class="font-semibold text-blue-500 flex items-center">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                            Low Tide
                                        </span>
                                        <strong>2:33 PM</strong>
                                    </li>
                                     <li class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                                        <span class="font-semibold text-blue-700 flex items-center">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                            High Tide
                                        </span>
                                        <strong>9:53 PM</strong>
                                    </li>
                                </ul>
                            </div>
                            <p class="text-xs text-gray-500 mt-4">
                                This is sample data. For real forecasts, check the official 
                                <a href="https://www.pagasa.dost.gov.ph/weather" target="_blank" class="text-blue-600 hover:underline">PAGASA Daily Weather Forecast</a>.
                            </p>
                        </div>
                        <div id="buttons-card" class="bg-white p-6 rounded-lg shadow-md">
                          <div class="actions-buttons-row">
                            <button onclick="showView('maps')" class="btn-animated w-full px-6 py-3 text-white font-semibold rounded-lg bg-blue-600 hover:bg-blue-700 transition duration-300 flex items-center justify-start">
                              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 3v3m6-3v3m0 0l-6 3"></path></svg>
                              Nearest Evacuation Site
                            </button>

                            <button onclick="showView('register')" class="btn-animated w-full px-6 py-3 text-white font-semibold rounded-lg bg-green-600 hover:bg-green-700 transition duration-300 flex items-center justify-start">
                              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                              Subscribe for SMS Alert
                            </button>
                          </div>
                        </div>

                        </div>
                </div>
            </div>
             <div id="maps-view" style="display: none;">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Evacuation Centers Map</h2>
                    <p class="mb-4 text-gray-600">Click on any marker to get directions to the evacuation center.</p>
                    <div style="height: 600px; width: 100%; border-radius: 8px; overflow: hidden;">
                        <iframe 
                            src="https://www.google.com/maps/d/embed?mid=1goBzdKF9AG5rIB7eTAtHwd09iSSS0WI&ehbc=2E312F" 
                            width="100%" 
                            height="600" 
                            style="border:0;" 
                            allowfullscreen="" 
                            loading="lazy" 
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                </div>
            </div>
            
            <div id="login-view" style_="display: none;">
                <div class="max-w-sm mx-auto bg-white p-8 rounded-lg shadow-md mt-10">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-700 text-center">Login</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-email" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                            <input type="email" id="login-email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your email" required>
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                            <input type="password" id="login-password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your password" required>
                            <a href="#" onclick="handlePasswordReset()" class="text-sm text-blue-600 hover:underline mt-2 inline-block">Forgot Password?</a>
                        </div>
                        <div id="login-message" class="mb-4 p-3 rounded-lg text-sm" style="display:none;"></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Login</button>
                    </form>
                    </div>
            </div>

        </main>

        <footer class="bg-white">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-gray-600">
                ¬© 2025 SurgeAlert. All rights reserved.
            </div>
        </footer>
    </div>

    <script>
        // Global variables and view management
        // 'register-view' is still removed from this array
        const views = ['home-view', 'maps-view', 'login-view'];
        let map;

        function showView(viewName) {
            const viewId = viewName.includes('-view') ? viewName : viewName + '-view';
            
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            // Check if the view exists before trying to show it
            const target = document.getElementById(viewId);
            if (target) {
                target.style.display = 'block';
            } else if (viewId === 'register-view') {
                // Friendly warning if someone clicks the (currently) dead button
                console.warn('Register view is not available.');
                alert('Registration is currently disabled.');
            }


            if (viewId === 'maps-view' && !map) {
                setTimeout(initMap, 100);
            }
            
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu && mobileMenu.style.display === 'block') {
                mobileMenu.style.display = 'none';
            }
        }

        // Mobile Menu Toggle
        document.addEventListener('DOMContentLoaded', () => {
            const mobileBtn = document.getElementById('mobile-menu-button');
            if (mobileBtn) {
                mobileBtn.addEventListener('click', function() {
                    const mobileMenu = document.getElementById('mobile-menu');
                    if (mobileMenu.style.display === 'none' || !mobileMenu.style.display) {
                        mobileMenu.style.display = 'block';
                    } else {
                        mobileMenu.style.display = 'none';
                    }
                });
            }
            
            showView('home');
            // initial run
            updateAlertStatus();
            
            // auto-run every 30 seconds
            setInterval(updateAlertStatus, 30000); 
            
            fetchWeather();
        });

        // Full bilingual Alert Level Action Guide (unchanged)
        const ALERT_GUIDE = {
            green: {
                title: 'LEVEL 1 GREEN: BE AWARE & PREPARE',
                title_tl: 'LEVEL 1 GREEN: MAGING HANDA AT ALERTO',
                short_en: 'The river is safe. There is no immediate flood risk.',
                short_tl: 'Ligtas ang ilog. Walang direktang panganib ng baha.',
                actions: [
                    {en: 'KNOW YOUR PLAN: Review your family\'s evacuation route and check your emergency "Go Bag."', tl: 'BALIKAN ANG PLANO: Tingnan muli ang inyong evacuation route at siguraduhing kumpleto ang laman ng inyong "Go Bag."'},
                    {en: 'STAY INFORMED: Monitor official weather forecasts.', tl: 'ANTABAYANAN ANG BALITA: Subaybayan ang mga ulat ng panahon mula sa mga opisyal na ahensya.'}
                ]
            },
            yellow: {
                title: '‚ö†Ô∏è LEVEL 2 YELLOW: GET READY',
                title_tl: '‚ö†Ô∏è LEVEL 2 YELLOW: HUMANDA',
                short_en: 'The river is rising. Flooding is possible, especially in low-lying areas.',
                short_tl: 'Tumataas ang tubig sa ilog. Posible ang pagbaha, lalo na sa mabababang lugar.',
                actions: [
                    {en: 'LISTEN: Pay close attention to official announcements.', tl: 'MAKINIG SA ANUNSYO: Maging alerto sa mga anunsyo mula sa inyong barangay o DRRMO.'},
                    {en: 'CHARGE: Keep phones, power banks, and flashlights fully charged.', tl: 'I-CHARGE ANG MGA GAMIT: Siguraduhing full-charge ang mga cellphone, power bank, at flashlight.'},
                    {en: 'SECURE YOUR HOME: Move valuables and documents to higher ground.', tl: 'I-AKYAT ANG GAMIT: Ilipat ang mahahalagang kagamitan at dokumento sa mas mataas at ligtas na lugar.'}
                ]
            },
            orange: {
                title: 'üü† LEVEL 3 ORANGE: PREPARE TO EVACUATE',
                title_tl: 'üü† LEVEL 3 ORANGE: MAGHANDA PARA LUMIKAS',
                short_en: 'The situation is dangerous. Flooding is imminent or already starting in high-risk areas.',
                short_tl: 'Delikado na ang sitwasyon. Malapit nang bumaha o nagsimula na ang pagbaha sa mga high-risk na lugar.',
                actions: [
                    {en: 'EVACUATE IF ADVISED: If you are in a high-risk area, move to a safe place now.', tl: 'SIMULAN NANG LUMIKAS: Kung kayo ay nasa high-risk na lugar, umpisahan na ang paglikas sa ligtas na lugar.'},
                    {en: 'BE READY TO LEAVE: Grab your "Go Bag." Help neighbors who may need assistance.', tl: 'IHANDA NA ANG "GO BAG": Kunin na ang inyong "Go Bag." Tulungan ang mga kapitbahay na nangangailangan.'},
                    {en: 'PROTECT YOUR HOME: Turn off electricity and water only if it is safe to do so before leaving.', tl: 'ISARADO ANG BAHAY: Patayin ang kuryente at isara ang linya ng tubig kung ligtas gawin bago umalis.'}
                ]
            },
            red: {
                title: 'üö® LEVEL 4 RED: EVACUATE NOW!',
                title_tl: 'üö® LEVEL 4 RED: LUMIKAS NA!',
                short_en: 'The flood has reached a critical level. This is a mandatory evacuation order.',
                short_tl: 'Nasa kritikal na antas na ang baha. Ipinag-uutos ang sapilitang paglikas.',
                actions: [
                    {en: 'LEAVE IMMEDIATELY: For your safety, you must evacuate now.', tl: 'UMALIS AGAD: Para sa inyong kaligtasan, dapat na kayong lumikas ngayon.'},
                    {en: 'AVOID FLOODWATER: Do not walk or drive through flooded areas.', tl: 'IWASAN ANG BAHA: Huwag maglakad o magmaneho sa mga lugar na lubog sa baha.'},
                    {en: 'GO TO SAFETY: Proceed directly to the nearest evacuation center or high ground.', tl: 'PUMUNTA SA LIGTAS NA LUGAR: Dumiretso agad sa pinakamalapit na evacuation center o sa mas mataas na lugar.'}
                ]
            }
        };

        // This is the correct, working function from our last fix
        function updateAlertStatus() {
            const waterLevelEl = document.getElementById('water-level');
            const alertLevelEl = document.getElementById('alert-level');
            const alertDescEl = document.getElementById('alert-description');
            const actionsCard = document.getElementById('actions-card');
            const leftCard = document.getElementById('left-alert-card');

            let currentText = waterLevelEl.textContent.trim();
            let currentLevel = parseFloat(currentText) || 14.50;

            const change = (Math.random() - 0.45) * 0.25; 
            let newLevel = currentLevel + change;
            
            if (newLevel < 13.5) newLevel = 13.5;
            if (newLevel > 19.0) newLevel = 19.0;

            waterLevelEl.textContent = newLevel.toFixed(2) + ' m';

            let levelKey;
            if (newLevel < 15) {
                levelKey = 'green';
            } else if (newLevel >= 15 && newLevel < 16) {
                levelKey = 'yellow';
            } else if (newLevel >= 16 && newLevel < 18) {
                levelKey = 'orange';
            } else {
                levelKey = 'red';
            }

            const guide = ALERT_GUIDE[levelKey];
            alertLevelEl.textContent = guide.title;

            let html = '';
            html += `<div class="mb-2"><strong>${guide.title}</strong><br/><em>${guide.title_tl}</em></div>`;
            
            // This fix is from your CSS file issue, which overrides the color.
            // We add the class here to ensure it's visible.
            html += `<p class="mb-2 text-gray-700">${guide.short_en}</p>`;
            html += `<p class="mb-4 text-gray-700"><em>${guide.short_tl}</em></p>`;
            
            html += `<h4 class="font-semibold mb-2">Actions / Gabay</h4>`;
            html += `<ol class="list-decimal list-inside space-y-2 text-sm">`;
            guide.actions.forEach(act => {
                html += `<li><strong>${act.en}</strong><div class="text-gray-700">${act.tl}</div></li>`;
            });
            html += `</ol>`;
            alertDescEl.innerHTML = html;

            // FIX: Removed conflicting text-color classes from left card
            leftCard.classList.remove('bg-green-100','bg-yellow-100','bg-orange-100','bg-red-100','text-green-800','text-yellow-800','text-orange-800','text-red-800');
            if (levelKey === 'green') leftCard.classList.add('bg-green-100');
            if (levelKey === 'yellow') leftCard.classList.add('bg-yellow-100');
            if (levelKey === 'orange') leftCard.classList.add('bg-orange-100');
            if (levelKey === 'red') leftCard.classList.add('bg-red-100');

            
            // FIX: Properly clean up and set the h2 color on the right card
            actionsCard.classList.remove('border-green-500','border-yellow-400','border-orange-500','border-red-600');

            const h2 = actionsCard.querySelector('h2');
            h2.classList.remove('text-gray-700', 'text-green-800', 'text-yellow-800', 'text-orange-800', 'text-red-800');

            if (levelKey === 'green') {
                actionsCard.classList.add('border-green-500');
                h2.classList.add('text-green-800'); 
            } else if (levelKey === 'yellow') {
                actionsCard.classList.add('border-yellow-400');
                h2.classList.add('text-yellow-800');
            } else if (levelKey === 'orange') {
                actionsCard.classList.add('border-orange-500');
                h2.classList.add('text-orange-800');
            } else if (levelKey === 'red') {
                actionsCard.classList.add('border-red-600');
                h2.classList.add('text-red-800');
            } else {
                h2.classList.add('text-gray-700');
            }
        }

        // Weather Forecast (unchanged)
        async function fetchWeather() {
            const weatherContainer = document.getElementById('weather-forecast');
            const url = `https://api.open-meteo.com/v1/forecast?latitude=14.6773&longitude=120.9842&hourly=temperature_2m,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia/Singapore`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                weatherContainer.innerHTML = '';

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = 0; i < 5; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    
                    const dayData = data.daily;
                    const dayIndex = data.daily.time.findIndex(t => new Date(t).toDateString() === date.toDateString());
                    
                    if (dayIndex === -1) continue;

                    const day = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const tempMax = Math.round(dayData.temperature_2m_max[dayIndex]);
                    const tempMin = Math.round(dayData.temperature_2m_min[dayIndex]);
                    const weatherCode = dayData.weathercode[dayIndex];
                    
                    const weatherInfo = getWeatherInfo(weatherCode);

                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 p-3 rounded-lg flex flex-col items-center';
                    card.innerHTML = `
                        <p class="font-semibold">${day}</p>
                        <div class="text-4xl my-2">${weatherInfo.icon}</div>
                        <p class="text-sm">${weatherInfo.description}</p>
                        <p class="text-sm mt-1 font-medium">${tempMax}¬∞ / ${tempMin}¬∞</p>
                    `;
                    weatherContainer.appendChild(card);
                }
            } catch (error) {
                console.error('Failed to fetch weather data:', error);
                weatherContainer.innerHTML = '<p class="text-red-500 col-span-full">Could not load weather data.</p>';
            }
        }

		function getWeatherInfo(code) {
            const weatherMap = {
                0: { description: 'Sunny', icon: '‚òÄÔ∏è' },
                1: { description: 'Sunny', icon: 'üå§Ô∏è' },
                2: { description: 'Partly Cloudy', icon: '‚õÖ' },
                3: { description: 'Cloudy', icon: '‚òÅÔ∏è' },
                4: { description: 'Hazy', icon: 'üå´Ô∏è' },
                5: { description: 'Hazy', icon: 'üå´Ô∏è' }, 
                10: { description: 'Misty', icon: 'üå´Ô∏è' }, 
                45: { description: 'Foggy', icon: 'üå´Ô∏è' },
                48: { description: 'Foggy', icon: 'üå´Ô∏è' },
                51: { description: 'Light Rain', icon: 'üå¶Ô∏è' },
                53: { description: 'Light Rain', icon: 'üå¶Ô∏è' },
                55: { description: 'Light Rain', icon: 'üå¶Ô∏è' },
                61: { description: 'Rain', icon: 'üåßÔ∏è' },
                63: { description: 'Rain', icon: 'üåßÔ∏è' },
                65: { description: 'Heavy Rain', icon: 'üåßÔ∏è' },
                80: { description: 'Showers', icon: 'üå¶Ô∏è' },
                81: { description: 'Showers', icon: 'üå¶Ô∏è' },
                82: { description: 'Heavy Showers', icon: 'üå¶Ô∏è' },
                95: { description: 'Thunderstorm', icon: '‚õàÔ∏è' },
                96: { description: 'Thunderstorm', icon: '‚õàÔ∏è' }, 
                99: { description: 'Thunderstorm', icon: '‚õàÔ∏è' }, 
            };
            return weatherMap[code] || { description: 'Unknown', icon: '‚ùì' };
        }

        // Map Initialization (unchanged)
        function initMap() {
            map = L.map('map').setView([14.6773, 120.9842], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            const evacuationSites = [
                { name: 'Marulas Elementary School', lat: 14.6780, lng: 120.9850, address: 'Marulas, Valenzuela City' },
                { name: 'Marulas High School', lat: 14.6765, lng: 120.9835, address: 'Marulas, Valenzuela City' },
                { name: 'Valenzuela City Astrodome', lat: 14.6640, lng: 120.9880, address: 'MacArthur Highway, Valenzuela City' },
                { name: 'Valenzuela City People\'s Park', lat: 14.6590, lng: 120.9890, address: 'Gen. T. de Leon, Valenzuela City' },
                { name: 'Coloong Elementary School', lat: 14.6950, lng: 120.9720, address: 'Coloong, Valenzuela City' }
            ];

            const customIcon = L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
                shadowSize: [41, 41]
            });

            evacuationSites.forEach(site => {
                L.marker([site.lat, site.lng], {icon: customIcon}).addTo(map)
                    .bindPopup(`<b>${site.name}</b><br>${site.address}`);
            });
        }
    </script>

</body>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  import { 
    getAuth, 
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    getDoc 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  // Registration and storage imports are still removed

  const firebaseConfig = {
    apiKey: "AIzaSyBvryg0lG5ZRHeU4ucx32Go2dD4jxWrnr4",
    authDomain: "surgealert-3be99.firebaseapp.com",
    projectId: "surgealert-3be99",
    storageBucket: "surgealert-3be99.firebasestorage.app",
    messagingSenderId: "927215166423",
    appId: "1:927215166423:web:075e1bd4950ae629b5e192",
    measurementId: "G-K4MBQ91SB5"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.firebaseAuth = auth;
  window.firebaseDb = db;

  // Show message helper
  function showMessage(elementId, message, type) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.className = `mb-4 p-3 rounded-lg text-sm ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
    element.style.display = 'block';
    
    setTimeout(() => {
      element.style.display = 'none';
    }, 5000);
  }

  // Registration Handler (Still Removed)

  // Login Handler
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      
      if (!userCredential.user.emailVerified) {
        showMessage('login-message', 'Please verify your email before logging in. Check your inbox.', 'error');
        await signOut(auth);
        return;
      }
      
      showMessage('login-message', 'Login successful! Redirecting...', 'success');
      
      document.getElementById('login-form').reset();
      
      setTimeout(() => {
        showView('home');
      }, 1000);
      
    } catch (error) {
      console.error('Login error:', error);
      let errorMessage = 'Login failed. Please check your credentials.';
      
      if (error.code === 'auth/user-not-found') {
        errorMessage = 'No account found with this email.';
      } else if (error.code === 'auth/wrong-password') {
        errorMessage = 'Incorrect password.';
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = 'Invalid email address.';
      } else if (error.code === 'auth/invalid-credential') {
        errorMessage = 'Invalid email or password.';
      }
      
      showMessage('login-message', errorMessage, 'error');
    }
  });

  // Logout Handler
  window.handleLogout = async () => {
    try {
      await signOut(auth);
      showView('home');
      alert('Logged out successfully!');
    } catch (error) {
      console.error('Logout error:', error);
      alert('Failed to logout. Please try again.');
    }
  };

  // Password Reset Handler
  window.handlePasswordReset = async () => {
    const email = document.getElementById('login-email').value;
    
    if (!email) {
      alert('Please enter your email address first.');
      return;
    }
    
    try {
      await sendPasswordResetEmail(auth, email);
      alert('Password reset email sent! Check your inbox.');
    } catch (error) {
      console.error('Password reset error:', error);
      alert('Failed to send reset email. Please check your email address.');
    }
  };

  // Auth State Observer
  onAuthStateChanged(auth, async (user) => {
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userName = document.getElementById('user-name');
    const mobileLoginBtn = document.getElementById('mobile-login-btn');
    const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
    
    if (user && user.emailVerified) {
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      userName.style.display = 'inline-block';
      userName.textContent = `Welcome, ${user.displayName || user.email}`;
      
      if (mobileLoginBtn) mobileLoginBtn.style.display = 'none';
      if (mobileLogoutBtn) mobileLogoutBtn.style.display = 'block';
      
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
          console.log('User data:', userDoc.data());
        }
      } catch (error) {
        console.error('Error loading user data:', error);
      }
    } else {
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      userName.style.display = 'none';
      
      if (mobileLoginBtn) mobileLoginBtn.style.display = 'block';
      if (mobileLogoutBtn) mobileLogoutBtn.style.display = 'none';
    }
  });

</script>
</html>